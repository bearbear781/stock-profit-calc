<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Moomoo äº¤æ˜“è®¡ç®—å™¨ (Proç‰ˆ)</title>
  <style>
    :root {
      --primary: #0052cc;
      --primary-hover: #0747a6;
      --bg: #f4f5f7;
      --card-bg: #ffffff;
      --text: #172b4d;
      --success: #36b37e;
      --danger: #ff5630;
      --border: #dfe1e6;
    }
    
    * { box-sizing: border-box; outline: none; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0; padding: 20px 10px;
      line-height: 1.5;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      overflow: hidden;
    }

    .header {
      background: var(--primary);
      color: white;
      padding: 20px;
      text-align: center;
    }
    .header h2 { margin: 0; font-size: 1.4rem; }
    .header p { margin: 5px 0 0; opacity: 0.9; font-size: 0.9rem; }

    .tabs {
      display: flex;
      background: #ebecf0;
      padding: 4px;
      margin: 15px;
      border-radius: 8px;
    }
    
    .tab-btn {
      flex: 1;
      border: none;
      padding: 10px;
      border-radius: 6px;
      background: transparent;
      color: #5e6c84;
      font-weight: 600;
      cursor: pointer;
      transition: 0.2s;
    }
    
    .tab-btn.active {
      background: white;
      color: var(--primary);
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .content { padding: 0 20px 20px; }

    .input-group { margin-bottom: 15px; }
    .input-group label {
      display: block;
      font-size: 0.85rem;
      font-weight: 600;
      color: #5e6c84;
      margin-bottom: 6px;
    }
    
    .input-wrapper { position: relative; }
    .input-wrapper input, .input-wrapper select {
      width: 100%;
      padding: 12px;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.2s;
      background: white;
    }
    .input-wrapper input:focus { border-color: var(--primary); }
    
    .btn-row { display: flex; gap: 10px; margin-top: 20px; }
    
    button.action-btn {
      flex: 1;
      padding: 14px;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      font-size: 1rem;
      cursor: pointer;
      transition: transform 0.1s;
    }
    
    .btn-calc { background: var(--primary); color: white; }
    .btn-calc:active { transform: scale(0.98); }
    .btn-reset { background: #ebecf0; color: #5e6c84; max-width: 80px; }

    .result-card {
      background: #f0f7ff;
      border: 1px solid #b3d4ff;
      border-radius: 8px;
      padding: 15px;
      margin-top: 20px;
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .breakeven-badge {
      background: #ffab00;
      color: #172b4d;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: bold;
      display: inline-block;
      margin-top: 5px;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 0.95rem;
    }
    
    .highlight-val { font-weight: bold; color: var(--primary); }
    .profit-pos { color: var(--success); }
    .profit-neg { color: var(--danger); }

    /* è´¹ç”¨è¡¨æŠ˜å æ ·å¼ */
    .fees-accordion {
      margin: 20px 20px 0;
      border-top: 1px solid var(--border);
    }
    .accordion-header {
      width: 100%;
      padding: 15px 0;
      background: none;
      border: none;
      text-align: left;
      font-weight: 600;
      color: #5e6c84;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .accordion-header::after { content: '+'; font-size: 1.2rem; }
    .accordion-header.active::after { content: '-'; }
    
    .accordion-body {
      display: none;
      padding-bottom: 20px;
      font-size: 0.85rem;
      color: #42526e;
    }
    .accordion-body table { width: 100%; border-collapse: collapse; }
    .accordion-body th, .accordion-body td {
      border-bottom: 1px solid #ebecf0;
      padding: 8px;
      text-align: left;
    }
    
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <h2>Moomoo äº¤æ˜“è®¡ç®—å™¨</h2>
    <p>å« SST (8%) åŠæœ€æ–°å°èŠ±ç¨å°é¡¶</p>
  </div>

  <div class="tabs">
    <button class="tab-btn active" onclick="setMode('target')">ğŸ¯ è®¡ç®—ç›®æ ‡å–ä»·</button>
    <button class="tab-btn" onclick="setMode('profit')">ğŸ’° è®¡ç®—å®é™…ç›ˆäº</button>
  </div>

  <div class="content">
    <div class="input-group">
      <label>è‚¡ç¥¨ç±»å‹</label>
      <div class="input-wrapper">
        <select id="stockType">
          <option value="stock">ğŸ‡²ğŸ‡¾ æ­£è‚¡ (Bursa Stock)</option>
          <option value="warrant">ğŸ‡²ğŸ‡¾ æƒè¯/REITs (Warrants)</option>
          <option value="etf">ğŸ‡²ğŸ‡¾ ETF (å…å°èŠ±ç¨)</option>
        </select>
      </div>
    </div>

    <div class="input-group">
      <label>ä¹°å…¥ä»·æ ¼ (RM)</label>
      <div class="input-wrapper">
        <input type="number" id="buyPrice" step="0.001" placeholder="0.000">
      </div>
    </div>

    <div class="input-group">
      <label>è‚¡æ•° (Quantity)</label>
      <div class="input-wrapper">
        <input type="number" id="qty" placeholder="ä¾‹å¦‚: 1000 (10 Lots)">
      </div>
    </div>

    <div id="group-target" class="input-group">
      <label>ç›®æ ‡å‡€èµšé‡‘é¢ (RM)</label>
      <div class="input-wrapper">
        <input type="number" id="targetProfit" placeholder="ä½ æƒ³è¦èµšå¤šå°‘?">
      </div>
    </div>

    <div id="group-profit" class="input-group" style="display:none;">
      <label>å–å‡ºä»·æ ¼ (RM)</label>
      <div class="input-wrapper">
        <input type="number" id="sellPrice" step="0.001" placeholder="0.000">
      </div>
    </div>

    <div class="btn-row">
      <button class="action-btn btn-reset" onclick="resetForm()">é‡ç½®</button>
      <button class="action-btn btn-calc" onclick="calculate()">å¼€å§‹è®¡ç®—</button>
    </div>

    <div id="result" class="result-card"></div>
  </div>

  <div class="fees-accordion">
    <button class="accordion-header" onclick="toggleFees(this)">æŸ¥çœ‹è¯¦ç»†è´¹ç‡è¡¨ (2025)</button>
    <div class="accordion-body">
      <table>
        <tr><th>è´¹ç”¨</th><th>è´¹ç‡</th><th>å¤‡æ³¨</th></tr>
        <tr><td>ä½£é‡‘</td><td>0.03%</td><td>æœ€ä½ RM3.00</td></tr>
        <tr><td>å¹³å°è´¹</td><td>RM 0</td><td>ç›®å‰æ´»åŠ¨å…è´¹</td></tr>
        <tr><td>æ¸…ç®—è´¹</td><td>0.03%</td><td>å°é¡¶ RM1000</td></tr>
        <tr><td>SST</td><td>8%</td><td>é’ˆå¯¹ä½£é‡‘ã€æ¸…ç®—è´¹</td></tr>
        <tr><td>å°èŠ±ç¨</td><td>RM1 / RM1000</td><td>æ­£è‚¡å°é¡¶1000<br>æƒè¯å°é¡¶200</td></tr>
      </table>
      <p style="margin-top:10px; font-style:italic;">*æ³¨ï¼šMoomoo MY åŒä¸€æ—¥å†…å¯¹åŒä¸€åªè‚¡ç¥¨çš„å¤šæ¬¡äº¤æ˜“ä¼šè‡ªåŠ¨åˆå¹¶è®¡ç®—ä½£é‡‘ï¼ˆAmalgamationï¼‰ï¼Œæœ‰åŠ©äºèŠ‚çœæœ€ä½ä½£é‡‘æˆæœ¬ã€‚</p>
    </div>
  </div>
</div>

<script>
  let mode = 'target';

  function setMode(m) {
    mode = m;
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');
    
    document.getElementById('group-target').style.display = m === 'target' ? 'block' : 'none';
    document.getElementById('group-profit').style.display = m === 'profit' ? 'block' : 'none';
    document.getElementById('result').style.display = 'none';
  }

  function resetForm() {
    document.querySelectorAll('input').forEach(i => i.value = '');
    document.getElementById('result').style.display = 'none';
    document.getElementById('stockType').value = 'stock';
  }

  function toggleFees(btn) {
    btn.classList.toggle('active');
    const body = btn.nextElementSibling;
    body.style.display = body.style.display === 'block' ? 'none' : 'block';
  }

  // æ ¸å¿ƒè´¹ç”¨è®¡ç®—å‡½æ•°
  function getFees(amount, type) {
    // 1. ä½£é‡‘: 0.03%, æœ€ä½ RM3
    const commissionRaw = Math.max(amount * 0.0003, 3.00);
    
    // 2. å¹³å°è´¹: RM0
    const platformRaw = 0;
    
    // 3. æ¸…ç®—è´¹: 0.03%, å°é¡¶ RM1000
    const clearingRaw = Math.min(amount * 0.0003, 1000);
    
    // 4. SST (8%): ä½œç”¨äº ä½£é‡‘ + å¹³å°è´¹ + æ¸…ç®—è´¹
    const sst = (commissionRaw + platformRaw + clearingRaw) * 0.08;
    
    // 5. å°èŠ±ç¨
    let stampDuty = 0;
    if (type === 'stock') {
      stampDuty = Math.min(Math.ceil(amount / 1000), 1000);
    } else if (type === 'warrant') {
      stampDuty = Math.min(Math.ceil(amount / 1000), 200);
    } else {
      // ETF è±å…
      stampDuty = 0;
    }
    
    const total = commissionRaw + platformRaw + clearingRaw + sst + stampDuty;
    return { total, sst, stampDuty };
  }

  // å¯»æ‰¾ç‰¹å®šå‡€æ”¶ç›Šå¯¹åº”çš„å–å‡ºä»·ï¼ˆç”¨äºä¿æœ¬ä»·æˆ–ç›®æ ‡ä»·ï¼‰
  function findSellPriceForTarget(buyPrice, qty, type, targetNetProfit, totalBuyCost) {
    // ç²—ç•¥ä¼°ç®—èµ·ç‚¹: ä¹°å…¥æˆæœ¬ + ç›®æ ‡åˆ©æ¶¦ + é¢„ä¼°å–å‡ºè´¹(0.1%)
    let estimated = (totalBuyCost + targetNetProfit) / qty * 1.001; 
    let price = parseFloat(estimated.toFixed(3));
    
    // è¿­ä»£ä¿®æ­£ (æœ€å¤š100æ¬¡ï¼Œé˜²æ­¢æ­»å¾ªç¯)
    for(let i=0; i<100; i++) {
      let sellAmount = price * qty;
      let fees = getFees(sellAmount, type).total;
      let net = sellAmount - fees - totalBuyCost;
      
      if (Math.abs(net - targetNetProfit) < 0.5) break; // è¯¯å·®å°äº0.5åˆ†é’±å³å¯
      
      // è°ƒæ•´ä»·æ ¼
      if (net < targetNetProfit) price += 0.001;
      else price -= 0.001;
    }
    return price;
  }

  function calculate() {
    const type = document.getElementById('stockType').value;
    const buyPrice = parseFloat(document.getElementById('buyPrice').value);
    const qty = parseInt(document.getElementById('qty').value);
    
    if (!buyPrice || !qty || buyPrice <= 0 || qty <= 0) {
      alert("è¯·è¾“å…¥æœ‰æ•ˆçš„ä»·æ ¼å’Œè‚¡æ•°");
      return;
    }

    const buyAmount = buyPrice * qty;
    const buyFees = getFees(buyAmount, type);
    const totalBuyCost = buyAmount + buyFees.total;
    
    // è®¡ç®—ä¿æœ¬ä»·æ ¼ (Target Profit = 0)
    const breakevenPrice = findSellPriceForTarget(buyPrice, qty, type, 0, totalBuyCost);
    const breakevenPercent = ((breakevenPrice - buyPrice) / buyPrice * 100).toFixed(2);

    let html = '';

    if (mode === 'target') {
      const target = parseFloat(document.getElementById('targetProfit').value) || 0;
      const targetPrice = findSellPriceForTarget(buyPrice, qty, type, target, totalBuyCost);
      const targetPercent = ((targetPrice - buyPrice) / buyPrice * 100).toFixed(2);

      html = `
        <div class="summary-row">
          <span>ğŸ¯ å»ºè®®å–å‡ºä»·:</span>
          <span class="highlight-val" style="font-size:1.2rem">RM ${targetPrice.toFixed(3)}</span>
        </div>
        <div class="summary-row">
          <span>æ¶¨å¹…è¦æ±‚:</span>
          <span>${targetPercent}%</span>
        </div>
        <hr style="border:0; border-top:1px dashed #ccc; margin:10px 0;">
        <div class="summary-row">
          <span>ğŸ›¡ï¸ ä¿æœ¬å–å‡ºä»·:</span>
          <span>RM ${breakevenPrice.toFixed(3)} (${breakevenPercent}%)</span>
        </div>
        <div class="summary-row" style="font-size:0.85rem; color:#666;">
          <span>ä¹°å…¥æ€»æˆæœ¬:</span>
          <span>RM ${totalBuyCost.toFixed(2)}</span>
        </div>
      `;
    } else {
      const sellPrice = parseFloat(document.getElementById('sellPrice').value) || 0;
      const sellAmount = sellPrice * qty;
      const sellFees = getFees(sellAmount, type);
      const netReturn = sellAmount - sellFees.total;
      const profit = netReturn - totalBuyCost;
      const profitPercent = (profit / totalBuyCost * 100).toFixed(2);
      
      const profitClass = profit >= 0 ? 'profit-pos' : 'profit-neg';
      const profitLabel = profit >= 0 ? 'å‡€ç›ˆåˆ©' : 'å‡€äºæŸ';

      html = `
        <div class="summary-row">
          <span>${profitLabel}:</span>
          <span class="${profitClass}" style="font-size:1.2rem">RM ${Math.abs(profit).toFixed(2)}</span>
        </div>
        <div class="summary-row">
          <span>å›æŠ¥ç‡:</span>
          <span class="${profitClass}">${profitPercent}%</span>
        </div>
        <hr style="border:0; border-top:1px dashed #ccc; margin:10px 0;">
         <div class="summary-row">
          <span>ğŸ›¡ï¸ ä¿æœ¬å–å‡ºä»·:</span>
          <span>RM ${breakevenPrice.toFixed(3)}</span>
        </div>
        <div class="summary-row" style="font-size:0.85rem; color:#666;">
          <span>æ€»è´¹ç”¨ (ä¹°+å–):</span>
          <span>RM ${(buyFees.total + sellFees.total).toFixed(2)}</span>
        </div>
      `;
    }

    const resDiv = document.getElementById('result');
    resDiv.innerHTML = html;
    resDiv.style.display = 'block';
  }
</script>

</body>
</html>
