<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Moomoo MY 股票交易计算器 (2025最新版)</title>
  <style>
    :root {
      --primary: #1e88e5;
      --primary-hover: #1565c0;
      --bg-light: #f8fafc;
      --text-main: #212121;
      --card-bg: #ffffff;
      --border-color: #e0e0e0;
      --positive: #2e7d32;
      --negative: #c62828;
    }
    body {
      font-family: 'Segoe UI', Roboto, sans-serif;
      background-color: var(--bg-light);
      color: var(--text-main);
      margin: 0; padding: 1rem;
      max-width: 900px; margin-inline: auto;
    }
    h1 { text-align: center; color: var(--primary); }
    .calculator {
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      padding: 20px;
      margin-bottom: 20px;
    }
    .tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
    .tab {
      padding: 8px 16px; border-radius: 20px; border: 1px solid var(--primary);
      background: none; cursor: pointer; font-weight: 600; color: var(--primary);
    }
    .tab.active { background: var(--primary); color: white; }
    .form-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 5px; font-weight: bold; }
    input, select {
      width: 100%; padding: 10px; border: 1px solid var(--border-color);
      border-radius: 6px; box-sizing: border-box; font-size: 16px;
    }
    button.calc-btn {
      width: 100%; padding: 12px; background: var(--primary); color: white;
      border: none; border-radius: 6px; font-size: 16px; cursor: pointer; margin-top: 10px;
    }
    .result {
      margin-top: 20px; padding: 15px; border-radius: 8px;
      background: #f1f8ff; line-height: 1.8; display: none;
    }
    .highlight { color: var(--positive); font-weight: bold; }
    .fee-note { font-size: 0.85rem; color: #666; margin-top: 10px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
    th, td { border: 1px solid var(--border-color); padding: 8px; text-align: left; }
    th { background: #f1f8ff; }
  </style>
</head>
<body>

<h1>股票交易盈利计算器</h1>

<div class="calculator">
  <div class="tabs">
    <button class="tab active" onclick="switchTab('target')">目标卖出价</button>
    <button class="tab" onclick="switchTab('profit')">计算盈亏</button>
  </div>

  <div id="target-form">
    <div class="form-group">
      <label>股票类型</label>
      <select id="type">
        <option value="stock">正股 (Bursa Shares)</option>
        <option value="warrant">认股权证/REITs (Warrants/REITs)</option>
        <option value="etf">交易所买卖基金 (ETF)</option>
      </select>
    </div>
    <div class="form-group">
      <label>买入价格 (RM)</label>
      <input type="number" id="buyPrice" step="0.001" placeholder="例如: 1.550">
    </div>
    <div id="profit-only" style="display:none;" class="form-group">
      <label>卖出价格 (RM)</label>
      <input type="number" id="sellPrice" step="0.001">
    </div>
    <div class="form-group">
      <label>股数 (Quantity)</label>
      <input type="number" id="qty" placeholder="例如: 1000">
    </div>
    <div id="target-only" class="form-group">
      <label>目标净盈利 (RM)</label>
      <input type="number" id="targetProfit" placeholder="例如: 500">
    </div>
    <button class="calc-btn" onclick="performCalculation()">开始计算</button>
  </div>

  <div id="resultBox" class="result"></div>
</div>

<div class="calculator">
  <h3>最新费率标准 (Moomoo MY)</h3>
  <table>
    <tr><th>项目</th><th>正股</th><th>Warrants/REITs</th><th>ETF</th></tr>
    <tr><td>佣金</td><td colspan="3">0.03% (最低 RM 3.00)</td></tr>
    <tr><td>平台费</td><td colspan="3">RM 0 (目前活动豁免)</td></tr>
    <tr><td>清算费</td><td colspan="3">0.03% (最高 RM 1,000)</td></tr>
    <tr><td>SST 服务税</td><td colspan="3"><strong>8%</strong> (施加于佣金/平台费/清算费)</td></tr>
    <tr><td>印花税</td><td>每千收 RM1 (封顶1000)</td><td>每千收 RM1 (<strong>封顶200</strong>)</td><td><strong>豁免 (至2025年底)</strong></td></tr>
  </table>
</div>

<script>
  let currentMode = 'target';

  function switchTab(mode) {
    currentMode = mode;
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    event.target.classList.add('active');
    document.getElementById('target-only').style.display = (mode === 'target') ? 'block' : 'none';
    document.getElementById('profit-only').style.display = (mode === 'profit') ? 'block' : 'none';
    document.getElementById('resultBox').style.display = 'none';
  }

  function calculateFees(amount, type) {
    // 1. 佣金 (0.03% 或最低 RM3)
    let commission = Math.max(amount * 0.0003, 3.00);
    // 2. 平台费 (目前 Moomoo MY 对马股免平台费)
    let platformFee = 0;
    // 3. 清算费 (0.03% 封顶 RM1000)
    let clearingFee = Math.min(amount * 0.0003, 1000);
    // 4. SST (8%) - 针对佣金+平台费+清算费
    let sst = (commission + platformFee + clearingFee) * 0.08;
    // 5. 印花税
    let stampDuty = 0;
    if (type === 'stock') {
      stampDuty = Math.min(Math.ceil(amount / 1000), 1000);
    } else if (type === 'warrant') {
      stampDuty = Math.min(Math.ceil(amount / 1000), 200);
    } else {
      stampDuty = 0; // ETF 豁免
    }

    return {
      commission, clearingFee, sst, stampDuty,
      total: commission + platformFee + clearingFee + sst + stampDuty
    };
  }

  function performCalculation() {
    const type = document.getElementById('type').value;
    const buyPrice = parseFloat(document.getElementById('buyPrice').value);
    const qty = parseInt(document.getElementById('qty').value);
    const resBox = document.getElementById('resultBox');

    if (isNaN(buyPrice) || isNaN(qty)) return alert("请完整输入数据");

    const buyAmount = buyPrice * qty;
    const buyFees = calculateFees(buyAmount, type);
    const totalCost = buyAmount + buyFees.total;

    let output = "";

    if (currentMode === 'target') {
      const targetProfit = parseFloat(document.getElementById('targetProfit').value) || 0;
      // 简单迭代寻找目标价
      let sPrice = buyPrice + 0.001;
      let net = 0;
      while (net < (totalCost + targetProfit)) {
        let sAmount = sPrice * qty;
        let sFees = calculateFees(sAmount, type);
        net = sAmount - sFees.total;
        sPrice += 0.001;
        if (sPrice > buyPrice * 5) break; // 防止死循环
      }
      
      const finalSellFees = calculateFees(sPrice * qty, type);
      output = `
        <strong>目标卖出价: <span class="highlight">RM ${sPrice.toFixed(3)}</span></strong><br>
        买入总成本: RM ${totalCost.toFixed(2)} (含税费 RM ${buyFees.total.toFixed(2)})<br>
        预计卖出费用: RM ${finalSellFees.total.toFixed(2)} (含 SST RM ${finalSellFees.sst.toFixed(2)})<br>
        <span class="fee-note">* 已考虑 0.03% 佣金(最低RM3)、8% SST 及相应印花税上限。</span>
      `;
    } else {
      const sellPrice = parseFloat(document.getElementById('sellPrice').value);
      if (isNaN(sellPrice)) return alert("请输入卖出价格");
      
      const sellAmount = sellPrice * qty;
      const sellFees = calculateFees(sellAmount, type);
      const netProceeds = sellAmount - sellFees.total;
      const profit = netProceeds - totalCost;

      output = `
        买入成本: RM ${totalCost.toFixed(2)}<br>
        卖出净得: RM ${netProceeds.toFixed(2)}<br>
        最终盈亏: <span class="${profit>=0?'highlight':'negative'}">RM ${profit.toFixed(2)}</span><br>
        盈利率: ${(profit/totalCost*100).toFixed(2)}%
      `;
    }

    resBox.innerHTML = output;
    resBox.style.display = 'block';
  }
</script>

</body>
</html>
